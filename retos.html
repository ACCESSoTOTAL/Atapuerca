<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Retos SQL - Atapuerca Net</title>
  <link rel="stylesheet" href="css/estilos.css" />
</head>
<body>
  <header>
    <div style="display: flex; align-items: center; justify-content: center; gap: 1em; flex-wrap: wrap;">
      <img src="docs/logo-atapuerca.png" alt="Logo Atapuerca" style="height: 100px; filter: drop-shadow(0 0 10px var(--primary-green));">
      <h1 class="glow">‚öîÔ∏è RETOS SQL</h1>
    </div>
    <nav>
      <a href="index.html">Inicio</a>
      <a href="retos.html">Retos</a>
      <a href="sql.html">Terminal SQL</a>
      <a href="descargas.html">Descargas</a>
      <a href="contacto.html">Contacto</a>
    </nav>
  </header>
  <main>
    <h2>üéØ Entrenamientos de la resistencia</h2>
    <p>Completa estos desaf√≠os SQL para entrenar tus habilidades y ganar puntos. Cada reto te acerca m√°s a convertirte en un maestro hacker de datos.</p>
    
    <div id="loading" style="text-align: center; padding: 40px; color: var(--accent-cyan);">
      üîÑ Cargando retos desde MySQL...
    </div>
    
    <div id="retos-container" style="display: none;">
      <!-- Los retos se cargar√°n aqu√≠ din√°micamente -->
    </div>
    
    <div style="margin-top: 3em; padding: 1.5em; background: var(--bg-light); border-radius: 5px; border-left: 4px solid var(--accent-cyan);">
      <h4 style="margin: 0 0 1em 0; color: var(--accent-cyan);">üìã Instrucciones:</h4>
      <ol style="margin: 0; padding-left: 1.5em; color: var(--text-secondary);">
        <li>Lee la descripci√≥n del reto</li>
        <li>Si necesitas ayuda, haz clic en "üí° Pista"</li>
        <li>Haz clic en "üöÄ Ir al Terminal" para escribir tu consulta</li>
        <li>El sistema detectar√° autom√°ticamente si has completado el reto</li>
        <li>¬°Gana puntos y desbloquea nuevos desaf√≠os!</li>
      </ol>
    </div>
    
    <!-- Botones de Administraci√≥n -->
    <div style="margin-top: 2em; padding: 1.5em; background: var(--bg-medium); border-radius: 5px; border-left: 4px solid var(--accent-orange); text-align: center;">
      <h4 style="margin: 0 0 1em 0; color: var(--accent-orange);">‚öôÔ∏è Administraci√≥n:</h4>
      
      <div style="display: flex; gap: 1em; justify-content: center; flex-wrap: wrap; margin-bottom: 1em;">
        <!-- Bot√≥n Desbloquear Todos -->
        <button 
          onclick="desbloquearTodosLosRetos()" 
          style="
            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green)); 
            color: var(--bg-dark); 
            border: none; 
            padding: 1em 2em; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0, 255, 65, 0.3);
            transition: all 0.3s ease;
          "
          onmouseover="this.style.transform='translateY(-2px)'"
          onmouseout="this.style.transform='translateY(0)'"
        >
          üîì Desbloquear Todos los Retos
        </button>
        
        <!-- Bot√≥n Modo Desarrollador -->
        <button 
          onclick="modoDesarrollador()" 
          style="
            background: linear-gradient(135deg, var(--accent-cyan), #0066cc); 
            color: var(--bg-dark); 
            border: none; 
            padding: 1em 2em; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0, 221, 255, 0.3);
          "
        >
          üîß Modo Desarrollador
        </button>
        
        <!-- Bot√≥n Reset -->
        <button 
          onclick="resetearProgreso()" 
          style="
            background: linear-gradient(135deg, #ff4444, #cc0000); 
            color: white; 
            border: none; 
            padding: 1em 2em; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3);
          "
        >
          üîÑ Reset Progreso
        </button>
        
        <!-- Bot√≥n Panel Administraci√≥n -->
        <button 
          onclick="accederAdministracion()" 
          style="
            background: linear-gradient(135deg, #8b5cf6, #6d28d9); 
            color: white; 
            border: none; 
            padding: 1em 2em; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
          "
        >
          üîê Panel Administraci√≥n
        </button>
      </div>
    </div>
  </main>

  <script>
    // ========================================
    // VARIABLES GLOBALES
    // ========================================
    let retosCache = [];
    let progresoUsuario = {};
    const API_URL = 'https://atapuerca-net.es/api/retos.php';
    // ========================================
    // CONFIGURACI√ìN DE USUARIO
    // ========================================
    function obtenerUsuarioId() {
      // Intentar obtener ID existente del localStorage
      let usuarioId = localStorage.getItem('atapuerca_usuario_id');
      
      if (!usuarioId) {
        // Generar ID √∫nico basado en timestamp y random
        usuarioId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('atapuerca_usuario_id', usuarioId);
        console.log('üÜî Nuevo usuario ID generado:', usuarioId);
      }
      
      return usuarioId;
    }
    
    const USUARIO_ID = obtenerUsuarioId(); // ID √∫nico por navegador

    // ========================================
    // FUNCI√ìN PRINCIPAL DE CARGA
    // ========================================
    async function cargarRetos() {
      try {
        console.log('üîÑ Cargando retos desde MySQL...');
        
        // Mostrar loading
        document.getElementById('loading').style.display = 'block';
        document.getElementById('retos-container').style.display = 'none';
        
        // Cargar retos SOLO (sin progreso desde API)
        const retosResponse = await fetch(API_URL + '?action=list&activo=1&_t=' + Date.now(), {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
          }
        });
        
        if (!retosResponse.ok) {
          throw new Error('HTTP ' + retosResponse.status + ': ' + retosResponse.statusText);
        }
        
        const retosData = await retosResponse.json();
        
        if (!retosData.success) {
          throw new Error(retosData.error || 'Error desconocido en la API');
        }
        
        retosCache = retosData.data;
        console.log('‚úÖ ' + retosData.total + ' retos cargados');
        
        // Cargar progreso SOLO desde localStorage
        console.log('üîÑ Cargando progreso desde localStorage...');
        const localProgress = localStorage.getItem('retoProgress');
        if (localProgress) {
          try {
            const localData = JSON.parse(localProgress);
            progresoUsuario = {};
            Object.keys(localData).forEach(retoId => {
              if (localData[retoId].completado) {
                progresoUsuario[retoId] = {
                  completado: localData[retoId].completado,
                  puntos_ganados: localData[retoId].puntos || 10,
                  fecha_completion: localData[retoId].fecha || new Date().toISOString()
                };
              }
            });
            console.log('‚úÖ Progreso cargado desde localStorage: ' + Object.keys(progresoUsuario).length + ' retos completados');
          } catch (localError) {
            console.error('‚ùå Error parseando localStorage:', localError);
            progresoUsuario = {};
          }
        } else {
          console.log('üìù No hay progreso previo en localStorage');
          progresoUsuario = {};
        }
        
        mostrarRetos(retosCache);
        
      } catch (error) {
        console.error('‚ùå Error:', error);
        mostrarError('Error cargando retos: ' + error.message);
      }
    }

    // ========================================
    // MOSTRAR RETOS EN LA P√ÅGINA
    // ========================================
    function mostrarRetos(retos) {
      const container = document.getElementById('retos-container');
      const loading = document.getElementById('loading');
      
      if (!container) {
        console.error('‚ùå Container no encontrado');
        return;
      }
      
      // Agrupar por fases
      const fases = {};
      retos.forEach(function(reto) {
        if (!fases[reto.fase]) fases[reto.fase] = [];
        fases[reto.fase].push(reto);
      });
      
      let html = '';
      
      // Info de fases
      const infoFases = {
        1: { titulo: "üìö Fase 1: Fundamentos B√°sicos", color: "var(--primary-green)" },
        2: { titulo: "üîó Fase 2: Tutorial JOINs", color: "var(--accent-cyan)" },
        3: { titulo: "üìà Fase 3: An√°lisis Avanzado", color: "var(--accent-orange)" },
        4: { titulo: "üéØ Fase 4: Consultas Expertas", color: "#ff6b6b" },
        5: { titulo: "üèÜ Fase 5: Maestr√≠a SQL", color: "#8b5cf6" }
      };
      
      // Generar HTML
      Object.keys(fases).sort(function(a, b) { return parseInt(a) - parseInt(b); }).forEach(function(fase) {
        const retosFase = fases[fase];
        const info = infoFases[fase] || { titulo: 'Fase ' + fase, color: "var(--text-primary)" };
        
        html += '<div style="margin-bottom: 2em;">';
        html += '<h3 style="color: ' + info.color + '; margin-bottom: 1em;">' + info.titulo + '</h3>';
        html += '<div style="display: grid; gap: 1em;">';
        
        retosFase.forEach(function(reto) {
          html += crearTarjetaReto(reto);
        });
        
        html += '</div></div>';
      });
      
      container.innerHTML = html;
      loading.style.display = 'none';
      container.style.display = 'block';
      
      // Actualizar gamificaci√≥n despu√©s de cargar los retos
      actualizarGamificacion();
    }

    // ========================================
    // CREAR TARJETA DE RETO
    // ========================================
    function crearTarjetaReto(reto) {
      const completado = progresoUsuario[reto.id] ? progresoUsuario[reto.id].completado : false;
      
      // Verificar si el reto est√° bloqueado (retos anteriores no completados)
      let bloqueado = false;
      if (reto.id > 1) {
        // Verificar que todos los retos anteriores est√©n completados
        for (let i = 1; i < reto.id; i++) {
          if (!progresoUsuario[i] || !progresoUsuario[i].completado) {
            bloqueado = true;
            break;
          }
        }
      }
      
      const icono = completado ? '‚úÖ' : (bloqueado ? 'üîí' : 'üéØ');
      const borderColor = completado ? 'var(--primary-green)' : (bloqueado ? '#666' : 'var(--border-color)');
      const opacity = bloqueado ? '0.5' : '1';
      
      return `
        <div style="
          background: var(--bg-light);
          border: 1px solid ${borderColor};
          border-radius: 8px;
          padding: 1.5em;
          opacity: ${opacity};
        ">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1em;">
            <h4 style="margin: 0; color: var(--text-primary); flex: 1;">
              ${icono} #${reto.id} - ${reto.titulo}
            </h4>
            <div style="display: flex; gap: 0.5em; align-items: center;">
              <span style="background: var(--accent-orange); color: var(--bg-dark); padding: 0.2em 0.6em; border-radius: 12px; font-size: 0.8em; font-weight: bold;">
                ${reto.puntos} pts
              </span>
              <span style="background: var(--bg-medium); color: var(--text-secondary); padding: 0.2em 0.6em; border-radius: 12px; font-size: 0.8em;">
                F${reto.fase}
              </span>
            </div>
          </div>
          
          <p style="color: var(--text-secondary); margin-bottom: 1em; font-size: 0.9em;">
            ${bloqueado ? 'üîí Completa los retos anteriores para desbloquear este.' : reto.descripcion}
          </p>
          
          <div style="display: flex; gap: 0.5em; flex-wrap: wrap;">
            <button onclick="${bloqueado ? 'mostrarMensajeBloqueo()' : `irAlReto(${reto.id})`}" style="
              background: ${bloqueado ? '#666' : 'var(--accent-cyan)'};
              color: var(--bg-dark);
              border: none;
              padding: 0.5em 1em;
              border-radius: 5px;
              font-weight: bold;
              cursor: ${bloqueado ? 'not-allowed' : 'pointer'};
            ">${bloqueado ? 'üîí Bloqueado' : 'üöÄ Ir al Terminal'}</button>
            
            ${!bloqueado && reto.pista ? `<button onclick="mostrarPista(${reto.id})" style="
              background: var(--accent-orange);
              color: var(--bg-dark);
              border: none;
              padding: 0.5em 1em;
              border-radius: 5px;
              font-weight: bold;
              cursor: pointer;
            ">üí° Pista</button>` : ''}
            
            ${!bloqueado && reto.consulta_sugerida ? `<button onclick="cargarEjemplo(${reto.id})" style="
              background: var(--bg-medium);
              color: var(--text-primary);
              border: 1px solid var(--border-color);
              padding: 0.5em 1em;
              border-radius: 5px;
              cursor: pointer;
            ">üìù Ejemplo</button>` : ''}
          </div>
        </div>
      `;
    }

    // ========================================
    // FUNCIONES DE BOTONES
    // ========================================
    function irAlReto(id) {
      const reto = retosCache.find(function(r) { return r.id === id; });
      if (reto) {
        localStorage.setItem('retoActual', JSON.stringify(reto));
        if (reto.consulta_sugerida) {
          localStorage.setItem('consultaPendiente', reto.consulta_sugerida);
        }
        window.location.href = 'sql.html?reto=true';
      }
    }

    function mostrarPista(id) {
      const reto = retosCache.find(function(r) { return r.id === id; });
      if (reto && reto.pista) {
        alert('üí° Pista para "' + reto.titulo + '":\n\n' + reto.pista);
      }
    }

    function cargarEjemplo(id) {
      const reto = retosCache.find(function(r) { return r.id === id; });
      if (reto && reto.consulta_sugerida) {
        localStorage.setItem('consultaPendiente', reto.consulta_sugerida);
        localStorage.setItem('retoActual', JSON.stringify(reto));
        window.location.href = 'sql.html?reto=true';
      }
    }

    function mostrarMensajeBloqueo() {
      alert('üîí Este reto est√° bloqueado.\n\nCompleta los retos anteriores para desbloquearlo.');
    }

    function accederAdministracion() {
      const password = prompt('üîê Introduce la contrase√±a de administraci√≥n:');
      if (password === 'ILoveAccess') {
        // Contrase√±a correcta - redirigir al panel de administraci√≥n
        window.open('admin/adminretos.html', '_blank');
      } else if (password !== null) {
        // Contrase√±a incorrecta (pero no cancel√≥)
        alert('‚ùå Contrase√±a incorrecta. Acceso denegado.');
      }
      // Si password es null (cancel√≥), no hacer nada
    }

    function desbloquearTodosLosRetos() {
      if (!confirm('¬øDesbloquear todos los retos? Esto marcar√° todos como completados en localStorage.')) return;
      
      // Crear progreso completo en localStorage
      let progreso = {};
      let puntuacionTotal = 0;
      
      retosCache.forEach(function(reto) {
        progreso[reto.id] = {
          completado: true,
          puntos: reto.puntos || 10,
          fecha: new Date().toISOString()
        };
        puntuacionTotal += (reto.puntos || 10);
      });
      
      // Guardar en localStorage
      localStorage.setItem('retoProgress', JSON.stringify(progreso));
      localStorage.setItem('puntuacionAtapuerca', puntuacionTotal.toString());
      
      alert(`¬°Todos los retos desbloqueados!\n${retosCache.length} retos completados\n${puntuacionTotal} puntos totales`);
      location.reload();
    }

    function modoDesarrollador() {
      const estado = localStorage.getItem('modoDesarrollador') === 'true';
      localStorage.setItem('modoDesarrollador', (!estado).toString());
      alert('Modo desarrollador ' + (!estado ? 'activado' : 'desactivado'));
      location.reload();
    }

    function resetearProgreso() {
      if (!confirm('¬øResetear todo el progreso? Esto eliminar√° todos los retos completados.')) return;
      if (!confirm('¬øEst√°s SEGURO? Esto volver√° todos los retos al estado inicial.')) return;
      
      // Limpiar localStorage
      localStorage.removeItem('retoProgress');
      localStorage.removeItem('puntuacionAtapuerca');
      localStorage.removeItem('atapuerca_usuario_id');
      
      alert('Progreso reseteado completamente. Todos los retos vuelven al estado inicial.');
      location.reload();
    }

    function mostrarError(mensaje) {
      const loading = document.getElementById('loading');
      const container = document.getElementById('retos-container');
      
      loading.style.display = 'none';
      container.innerHTML = `
        <div style="
          background: rgba(255, 68, 68, 0.1);
          border: 1px solid #ff4444;
          border-radius: 8px;
          padding: 2em;
          text-align: center;
          color: #ff4444;
        ">
          <h3>‚ùå Error</h3>
          <p>${mensaje}</p>
          <button onclick="location.reload()" style="
            background: #ff4444;
            color: white;
            border: none;
            padding: 1em 2em;
            border-radius: 5px;
            margin-top: 1em;
            cursor: pointer;
          ">üîÑ Reintentar</button>
        </div>
      `;
      container.style.display = 'block';
    }

    // ========================================
    // GAMIFICACI√ìN
    // ========================================
    
    function actualizarGamificacion() {
      const progreso = JSON.parse(localStorage.getItem('retoProgress') || '{}');
      const retosCompletados = Object.keys(progreso).length;
      
      // Calcular nivel y experiencia
      const experiencia = retosCompletados * 100;
      const nivel = Math.floor(experiencia / 500) + 1;
      const expEnNivel = experiencia % 500;
      const expParaSiguienteNivel = 500;
      const porcentajeExp = (expEnNivel / expParaSiguienteNivel) * 100;
      
      // Determinar fase actual
      const fases = [
        { titulo: "üî∞ Fase 1: Novato", color: "#4ade80" },
        { titulo: "‚öîÔ∏è Fase 2: Iniciado", color: "#60a5fa" },
        { titulo: "üõ°Ô∏è Fase 3: Veterano", color: "#a78bfa" },
        { titulo: "‚ö° Fase 4: Experto", color: "#fb7185" },
        { titulo: "üèÜ Fase 5: Maestr√≠a SQL", color: "#8b5cf6" }
      ];
      
      const faseActual = Math.min(Math.floor(nivel / 2), fases.length - 1);
      const fase = fases[faseActual];
      
      // Actualizar interfaz de gamificaci√≥n
      let gamificacionHTML = `
        <div style="margin-bottom: 2em; padding: 1.5em; background: linear-gradient(135deg, var(--bg-medium), var(--bg-dark)); border-radius: 10px; border: 2px solid ${fase.color};">
          <h3 style="margin: 0 0 1em 0; color: ${fase.color};">üéÆ Tu Progreso Hacker</h3>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1em; margin-bottom: 1em;">
            <div style="text-align: center;">
              <div style="font-size: 2em; color: ${fase.color};">Nivel ${nivel}</div>
              <div style="color: var(--text-secondary);">${fase.titulo}</div>
            </div>
            
            <div style="text-align: center;">
              <div style="font-size: 2em; color: var(--accent-cyan);">${retosCompletados}</div>
              <div style="color: var(--text-secondary);">Retos Completados</div>
            </div>
            
            <div style="text-align: center;">
              <div style="font-size: 2em; color: var(--accent-orange);">${experiencia}</div>
              <div style="color: var(--text-secondary);">Puntos de Experiencia</div>
            </div>
          </div>
          
          <div style="margin-top: 1em;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5em;">
              <span style="color: var(--text-secondary);">Progreso al siguiente nivel:</span>
              <span style="color: ${fase.color};">${expEnNivel}/${expParaSiguienteNivel} EXP</span>
            </div>
            <div style="background: var(--bg-dark); border-radius: 20px; overflow: hidden; height: 20px;">
              <div style="background: linear-gradient(90deg, ${fase.color}, ${fase.color}aa); width: ${porcentajeExp}%; height: 100%; transition: width 0.5s ease;"></div>
            </div>
          </div>
        </div>
      `;
      
      // Insertar la gamificaci√≥n al principio del contenedor de retos
      const retosContainer = document.getElementById('retos-container');
      if (retosContainer) {
        // Buscar si ya existe la gamificaci√≥n
        const gamificacionExistente = retosContainer.querySelector('[style*="üéÆ Tu Progreso Hacker"]');
        if (gamificacionExistente) {
          gamificacionExistente.outerHTML = gamificacionHTML;
        } else {
          retosContainer.insertAdjacentHTML('afterbegin', gamificacionHTML);
        }
      }
    }

    // ========================================
    // INICIALIZACI√ìN
    // ========================================
    
    // Forzar recarga sin cach√©
    function forzarRecarga() {
      // Limpiar cach√© del navegador
      if ('caches' in window) {
        caches.keys().then(function(names) {
          names.forEach(function(name) {
            caches.delete(name);
          });
        });
      }
      
      // Recargar con par√°metro √∫nico
      window.location.href = window.location.href.split('?')[0] + '?_nocache=' + Date.now();
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ P√°gina cargada, iniciando sistema...');
      
      // A√±adir bot√≥n de recarga forzada
      const adminSection = document.querySelector('div[style*="background: var(--bg-medium)"]');
      if (adminSection) {
        const buttonContainer = adminSection.querySelector('div[style*="display: flex"]');
        if (buttonContainer) {
          const forceReloadBtn = document.createElement('button');
          forceReloadBtn.onclick = forzarRecarga;
          forceReloadBtn.innerHTML = 'üîÑ Forzar Recarga';
          forceReloadBtn.style.cssText = `
            background: linear-gradient(135deg, #666, #333); 
            color: white; 
            border: none; 
            padding: 1em 2em; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
          `;
          buttonContainer.appendChild(forceReloadBtn);
        }
      }
      
      cargarRetos();
    });

    console.log('‚úÖ Script de retos cargado');
  </script>
</body>
</html>
