<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Retos SQL - Atapuerca Net</title>
  <link rel="stylesheet" href="css/estilos.css" />
</head>
<body>
  <header>
    <div style="display: flex; align-items: center; justify-content: center; gap: 1em; flex-wrap: wrap;">
      <img src="docs/logo-atapuerca.png" alt="Logo Atapuerca" style="height: 100px; filter: drop-shadow(0 0 10px var(--primary-green));">
      <h1 class="glow">‚öîÔ∏è RETOS SQL</h1>
    </div>
    <nav>
      <a href="index.html">Inicio</a>
      <a href="retos.html">Retos</a>
      <a href="sql.html">Terminal SQL</a>
      <a href="descargas.html">Descargas</a>
      <a href="contacto.html">Contacto</a>
    </nav>
  </header>
  <main>
    <h2>üéØ Entrenamientos de la resistencia</h2>
    <p>Completa estos desaf√≠os SQL para entrenar tus habilidades y ganar puntos. Cada reto te acerca m√°s a convertirte en un maestro hacker de datos.</p>
    
    <div id="loading" style="text-align: center; padding: 40px; color: var(--accent-cyan);">
      üîÑ Cargando retos desde MySQL...
    </div>
    
    <div id="retos-container" style="display: none;">
      <!-- Los retos se cargar√°n aqu√≠ din√°micamente -->
    </div>
    
    <div style="margin-top: 3em; padding: 1.5em; background: var(--bg-light); border-radius: 5px; border-left: 4px solid var(--accent-cyan);">
      <h4 style="margin: 0 0 1em 0; color: var(--accent-cyan);">üìã Instrucciones:</h4>
      <ol style="margin: 0; padding-left: 1.5em; color: var(--text-secondary);">
        <li>Lee la descripci√≥n del reto</li>
        <li>Si necesitas ayuda, haz clic en "üí° Pista"</li>
        <li>Haz clic en "üöÄ Ir al Terminal" para escribir tu consulta</li>
        <li>El sistema detectar√° autom√°ticamente si has completado el reto</li>
        <li>¬°Gana puntos y desbloquea nuevos desaf√≠os!</li>
      </ol>
    </div>
    
    <!-- Botones de Administraci√≥n -->
    <div style="margin-top: 2em; padding: 1.5em; background: var(--bg-medium); border-radius: 5px; border-left: 4px solid var(--accent-orange); text-align: center;">
      <h4 style="margin: 0 0 1em 0; color: var(--accent-orange);">‚öôÔ∏è Administraci√≥n:</h4>
      
      <div style="display: flex; gap: 1em; justify-content: center; flex-wrap: wrap; margin-bottom: 1em;">
        <!-- Bot√≥n Desbloquear Todos -->
        <button 
          onclick="desbloquearTodosLosRetos()" 
          style="
            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green)); 
            color: var(--bg-dark); 
            border: none; 
            padding: 1em 2em; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0, 255, 65, 0.3);
            transition: all 0.3s ease;
          "
          onmouseover="this.style.transform='translateY(-2px)'"
          onmouseout="this.style.transform='translateY(0)'"
        >
          üîì Desbloquear Todos los Retos
        </button>
        
        <!-- Bot√≥n Modo Desarrollador -->
        <button 
          onclick="modoDesarrollador()" 
          style="
            background: linear-gradient(135deg, var(--accent-cyan), #0066cc); 
            color: var(--bg-dark); 
            border: none; 
            padding: 1em 2em; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0, 221, 255, 0.3);
          "
        >
          üîß Modo Desarrollador
        </button>
        
        <!-- Bot√≥n Reset -->
        <button 
          onclick="resetearProgreso()" 
          style="
            background: linear-gradient(135deg, #ff4444, #cc0000); 
            color: white; 
            border: none; 
            padding: 1em 2em; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3);
          "
        >
          üîÑ Reset Progreso
        </button>
      </div>
    </div>
  </main>

  <script>
    // ========================================
    // VARIABLES GLOBALES
    // ========================================
    let retosCache = [];
    let progresoUsuario = {};
    const API_URL = 'https://atapuerca-net.es/api/retos.php';
    const USUARIO_ID = 'anonimo'; // Se podr√≠a hacer din√°mico en el futuro

    // ========================================
    // FUNCI√ìN PRINCIPAL DE CARGA
    // ========================================
    async function cargarRetos() {
      try {
        console.log('üîÑ Cargando retos desde MySQL...');
        
        // Mostrar loading
        document.getElementById('loading').style.display = 'block';
        document.getElementById('retos-container').style.display = 'none';
        
        // Cargar retos y progreso en paralelo
        const [retosResponse, progresoResponse] = await Promise.all([
          fetch(API_URL + '?action=list&activo=1&_t=' + Date.now(), {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Cache-Control': 'no-cache, no-store, must-revalidate',
              'Pragma': 'no-cache',
              'Expires': '0'
            }
          }),
          fetch(API_URL + '?action=get_progress&usuario_id=' + USUARIO_ID + '&_t=' + Date.now(), {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Cache-Control': 'no-cache, no-store, must-revalidate',
              'Pragma': 'no-cache',
              'Expires': '0'
            }
          })
        ]);
        
        if (!retosResponse.ok) {
          throw new Error('HTTP ' + retosResponse.status + ': ' + retosResponse.statusText);
        }
        
        const retosData = await retosResponse.json();
        
        if (!retosData.success) {
          throw new Error(retosData.error || 'Error desconocido en la API');
        }
        
        retosCache = retosData.data;
        console.log('‚úÖ ' + retosData.total + ' retos cargados');
        
        // Cargar progreso si est√° disponible
        if (progresoResponse.ok) {
          const progresoData = await progresoResponse.json();
          if (progresoData.success && progresoData.data) {
            progresoUsuario = {};
            progresoData.data.forEach(function(p) {
              progresoUsuario[p.reto_numero] = {
                completado: p.completado,
                puntos_ganados: p.puntos_ganados,
                fecha_completion: p.fecha_completion
              };
            });
            console.log('‚úÖ Progreso del usuario cargado: ' + Object.keys(progresoUsuario).length + ' retos completados');
          }
        }
        
        mostrarRetos(retosCache);
        
      } catch (error) {
        console.error('‚ùå Error:', error);
        mostrarError('Error cargando retos: ' + error.message);
      }
    }

    // ========================================
    // MOSTRAR RETOS EN LA P√ÅGINA
    // ========================================
    function mostrarRetos(retos) {
      const container = document.getElementById('retos-container');
      const loading = document.getElementById('loading');
      
      if (!container) {
        console.error('‚ùå Container no encontrado');
        return;
      }
      
      // Agrupar por fases
      const fases = {};
      retos.forEach(function(reto) {
        if (!fases[reto.fase]) fases[reto.fase] = [];
        fases[reto.fase].push(reto);
      });
      
      let html = '';
      
      // Info de fases
      const infoFases = {
        1: { titulo: "üìö Fase 1: Fundamentos B√°sicos", color: "var(--primary-green)" },
        2: { titulo: "üîó Fase 2: Tutorial JOINs", color: "var(--accent-cyan)" },
        3: { titulo: "üìà Fase 3: An√°lisis Avanzado", color: "var(--accent-orange)" },
        4: { titulo: "üéØ Fase 4: Consultas Expertas", color: "#ff6b6b" },
        5: { titulo: "üèÜ Fase 5: Maestr√≠a SQL", color: "#8b5cf6" }
      };
      
      // Generar HTML
      Object.keys(fases).sort(function(a, b) { return parseInt(a) - parseInt(b); }).forEach(function(fase) {
        const retosFase = fases[fase];
        const info = infoFases[fase] || { titulo: 'Fase ' + fase, color: "var(--text-primary)" };
        
        html += '<div style="margin-bottom: 2em;">';
        html += '<h3 style="color: ' + info.color + '; margin-bottom: 1em;">' + info.titulo + '</h3>';
        html += '<div style="display: grid; gap: 1em;">';
        
        retosFase.forEach(function(reto) {
          html += crearTarjetaReto(reto);
        });
        
        html += '</div></div>';
      });
      
      container.innerHTML = html;
      loading.style.display = 'none';
      container.style.display = 'block';
    }

    // ========================================
    // CREAR TARJETA DE RETO
    // ========================================
    function crearTarjetaReto(reto) {
      const completado = progresoUsuario[reto.id] ? progresoUsuario[reto.id].completado : false;
      const icono = completado ? '‚úÖ' : 'üéØ';
      
      return `
        <div style="
          background: var(--bg-light);
          border: 1px solid ${completado ? 'var(--primary-green)' : 'var(--border-color)'};
          border-radius: 8px;
          padding: 1.5em;
        ">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1em;">
            <h4 style="margin: 0; color: var(--text-primary); flex: 1;">
              ${icono} #${reto.id} - ${reto.titulo}
            </h4>
            <div style="display: flex; gap: 0.5em; align-items: center;">
              <span style="background: var(--accent-orange); color: var(--bg-dark); padding: 0.2em 0.6em; border-radius: 12px; font-size: 0.8em; font-weight: bold;">
                ${reto.puntos} pts
              </span>
              <span style="background: var(--bg-medium); color: var(--text-secondary); padding: 0.2em 0.6em; border-radius: 12px; font-size: 0.8em;">
                F${reto.fase}
              </span>
            </div>
          </div>
          
          <p style="color: var(--text-secondary); margin-bottom: 1em; font-size: 0.9em;">
            ${reto.descripcion}
          </p>
          
          <div style="display: flex; gap: 0.5em; flex-wrap: wrap;">
            <button onclick="irAlReto(${reto.id})" style="
              background: var(--accent-cyan);
              color: var(--bg-dark);
              border: none;
              padding: 0.5em 1em;
              border-radius: 5px;
              font-weight: bold;
              cursor: pointer;
            ">üöÄ Ir al Terminal</button>
            
            ${reto.pista ? `<button onclick="mostrarPista(${reto.id})" style="
              background: var(--accent-orange);
              color: var(--bg-dark);
              border: none;
              padding: 0.5em 1em;
              border-radius: 5px;
              font-weight: bold;
              cursor: pointer;
            ">üí° Pista</button>` : ''}
            
            ${reto.consulta_sugerida ? `<button onclick="cargarEjemplo(${reto.id})" style="
              background: var(--bg-medium);
              color: var(--text-primary);
              border: 1px solid var(--border-color);
              padding: 0.5em 1em;
              border-radius: 5px;
              cursor: pointer;
            ">üìù Ejemplo</button>` : ''}
          </div>
        </div>
      `;
    }

    // ========================================
    // FUNCIONES DE BOTONES
    // ========================================
    function irAlReto(id) {
      const reto = retosCache.find(function(r) { return r.id === id; });
      if (reto) {
        localStorage.setItem('retoActual', JSON.stringify(reto));
        if (reto.consulta_sugerida) {
          localStorage.setItem('consultaPendiente', reto.consulta_sugerida);
        }
        window.location.href = 'sql.html?reto=true';
      }
    }

    function mostrarPista(id) {
      const reto = retosCache.find(function(r) { return r.id === id; });
      if (reto && reto.pista) {
        alert('üí° Pista para "' + reto.titulo + '":\n\n' + reto.pista);
      }
    }

    function cargarEjemplo(id) {
      const reto = retosCache.find(function(r) { return r.id === id; });
      if (reto && reto.consulta_sugerida) {
        localStorage.setItem('consultaPendiente', reto.consulta_sugerida);
        localStorage.setItem('retoActual', JSON.stringify(reto));
        window.location.href = 'sql.html?reto=true';
      }
    }

    function desbloquearTodosLosRetos() {
      if (!confirm('¬øDesbloquear todos los retos? Esto guardar√° el progreso en la base de datos.')) return;
      
      let promesas = [];
      retosCache.forEach(function(reto) {
        promesas.push(guardarProgreso(reto.id, true, reto.puntos));
      });
      
      Promise.all(promesas).then(function() {
        alert('¬°Todos los retos desbloqueados y guardados en MySQL!');
        location.reload();
      }).catch(function(error) {
        console.error('Error al desbloquear retos:', error);
        alert('Error al guardar en MySQL: ' + error.message);
      });
    }

    function modoDesarrollador() {
      const estado = localStorage.getItem('modoDesarrollador') === 'true';
      localStorage.setItem('modoDesarrollador', (!estado).toString());
      alert('Modo desarrollador ' + (!estado ? 'activado' : 'desactivado'));
      location.reload();
    }

    function resetearProgreso() {
      if (!confirm('¬øResetear todo el progreso en MySQL?')) return;
      if (!confirm('¬øEst√°s SEGURO? Esto eliminar√° el progreso de la base de datos.')) return;
      
      // Solo limpiar localStorage, el progreso de MySQL se puede resetear desde el admin
      localStorage.clear();
      alert('LocalStorage limpiado. Usa el panel de administraci√≥n para resetear MySQL.');
      location.reload();
    }

    // ========================================
    // FUNCI√ìN PARA GUARDAR PROGRESO EN MYSQL
    // ========================================
    async function guardarProgreso(retoId, completado, puntos) {
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            action: 'save_progress',
            usuario_id: USUARIO_ID,
            reto_numero: retoId,
            completado: completado,
            puntos_ganados: puntos
          })
        });
        
        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'Error al guardar progreso');
        }
        
        // Actualizar cache local
        progresoUsuario[retoId] = {
          completado: completado,
          puntos_ganados: puntos,
          fecha_completion: new Date().toISOString()
        };
        
        return result;
      } catch (error) {
        console.error('Error al guardar progreso:', error);
        throw error;
      }
    }

    // ========================================
    // FUNCI√ìN PARA MARCAR RETO COMO COMPLETADO
    // ========================================
    async function marcarRetoCompletado(retoId, puntos) {
      try {
        await guardarProgreso(retoId, true, puntos);
        console.log('‚úÖ Reto ' + retoId + ' marcado como completado en MySQL');
        
        // Recargar la p√°gina para mostrar el cambio
        setTimeout(function() {
          location.reload();
        }, 1000);
        
      } catch (error) {
        console.error('Error al marcar reto completado:', error);
        alert('Error al guardar progreso: ' + error.message);
      }
    }

    function mostrarError(mensaje) {
      const loading = document.getElementById('loading');
      const container = document.getElementById('retos-container');
      
      loading.style.display = 'none';
      container.innerHTML = `
        <div style="
          background: rgba(255, 68, 68, 0.1);
          border: 1px solid #ff4444;
          border-radius: 8px;
          padding: 2em;
          text-align: center;
          color: #ff4444;
        ">
          <h3>‚ùå Error</h3>
          <p>${mensaje}</p>
          <button onclick="location.reload()" style="
            background: #ff4444;
            color: white;
            border: none;
            padding: 1em 2em;
            border-radius: 5px;
            margin-top: 1em;
            cursor: pointer;
          ">üîÑ Reintentar</button>
        </div>
      `;
      container.style.display = 'block';
    }

    // ========================================
    // INICIALIZACI√ìN
    // ========================================
    
    // Forzar recarga sin cach√©
    function forzarRecarga() {
      // Limpiar cach√© del navegador
      if ('caches' in window) {
        caches.keys().then(function(names) {
          names.forEach(function(name) {
            caches.delete(name);
          });
        });
      }
      
      // Recargar con par√°metro √∫nico
      window.location.href = window.location.href.split('?')[0] + '?_nocache=' + Date.now();
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ P√°gina cargada, iniciando sistema...');
      
      // A√±adir bot√≥n de recarga forzada
      const adminSection = document.querySelector('div[style*="background: var(--bg-medium)"]');
      if (adminSection) {
        const buttonContainer = adminSection.querySelector('div[style*="display: flex"]');
        if (buttonContainer) {
          const forceReloadBtn = document.createElement('button');
          forceReloadBtn.onclick = forzarRecarga;
          forceReloadBtn.innerHTML = 'üîÑ Forzar Recarga';
          forceReloadBtn.style.cssText = `
            background: linear-gradient(135deg, #666, #333); 
            color: white; 
            border: none; 
            padding: 1em 2em; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
          `;
          buttonContainer.appendChild(forceReloadBtn);
        }
      }
      
      cargarRetos();
    });

    console.log('‚úÖ Script de retos cargado');
  </script>
</body>
</html>
